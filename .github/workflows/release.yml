name: Build & Release

on:
  push:
    tags:
      - 'v*.*.*'

jobs:
  build:
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Setup NuGet
        uses: NuGet/setup-nuget@v2

      - name: Restore NuGet packages
        run: nuget restore SchoolSchedule.sln

      - name: Get version from tag
        id: version
        shell: bash
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Update AssemblyInfo version
        shell: powershell
        run: |
          $version = "${{ steps.version.outputs.VERSION }}"
          $file = "Properties\AssemblyInfo.cs"
          if (Test-Path $file) {
            (Get-Content $file) `
              -replace 'AssemblyVersion\(".*"\)', "AssemblyVersion(`"$version.0`")" `
              -replace 'AssemblyFileVersion\(".*"\)', "AssemblyFileVersion(`"$version.0`")" |
            Set-Content $file
          }

      - name: Build Release
        run: msbuild SchoolSchedule.sln /p:Configuration=Release /p:Platform="Any CPU" /p:OutputPath=bin\Release\publish

      - name: Collect build output
        shell: powershell
        run: |
          $src = "bin\Release\publish"
          $dst = "release_output"
          New-Item -ItemType Directory -Force -Path $dst | Out-Null
          # –ö–æ–ø–∏—Ä—É–µ–º exe –∏ –≤—Å–µ dll/–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
          Copy-Item "$src\*.exe" $dst -Force
          Copy-Item "$src\*.dll" $dst -Force
          Copy-Item "$src\*.config" $dst -Force
          Copy-Item "$src\*.json" $dst -ErrorAction SilentlyContinue -Force
          # –ö–æ–ø–∏—Ä—É–µ–º –ø–∞–ø–∫–∏ —Ä–µ—Å—É—Ä—Å–æ–≤ –µ—Å–ª–∏ –µ—Å—Ç—å
          foreach ($folder in @("Images", "Maps", "Pages")) {
            if (Test-Path $folder) {
              Copy-Item $folder $dst -Recurse -Force
            }
          }
          # –ö–æ–ø–∏—Ä—É–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ –∫–æ–Ω—Ñ–∏–≥–∏ –µ—Å–ª–∏ –µ—Å—Ç—å
          if (Test-Path "settings.json") { Copy-Item "settings.json" $dst -Force }

      - name: Create ZIP archive
        shell: powershell
        run: |
          Compress-Archive -Path "release_output\*" `
            -DestinationPath "SchoolSchedule-v${{ steps.version.outputs.VERSION }}.zip" `
            -Force

      - name: Download and setup Inno Setup
        shell: powershell
        run: |
          $url = "https://jrsoftware.org/download.php/is.exe"
          Invoke-WebRequest $url -OutFile "innosetup.exe"
          Start-Process -FilePath "innosetup.exe" -ArgumentList "/VERYSILENT /SUPPRESSMSGBOXES /NORESTART" -Wait

      - name: Build Installer
        shell: powershell
        run: |
          $version = "${{ steps.version.outputs.VERSION }}"
          # –í—Å—Ç–∞–≤–ª—è–µ–º –≤–µ—Ä—Å–∏—é –≤ —Å–∫—Ä–∏–ø—Ç
          (Get-Content "installer\SchoolSchedule.iss") `
            -replace '#define AppVersion ".*"', "#define AppVersion `"$version`"" |
          Set-Content "installer\SchoolSchedule_versioned.iss"
          
          & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" "installer\SchoolSchedule_versioned.iss"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: "SchoolSchedule ${{ github.ref_name }}"
          body: |
            ## üè´ SchoolSchedule ${{ github.ref_name }}
            
            ### –£—Å—Ç–∞–Ω–æ–≤–∫–∞
            - **–£—Å—Ç–∞–Ω–æ–≤—â–∏–∫** ‚Äî —Å–∫–∞—á–∞–π—Ç–µ `SchoolSchedule-Setup-v${{ steps.version.outputs.VERSION }}.exe` –∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ
            - **–ü–æ—Ä—Ç–∞—Ç–∏–≤–Ω–∞—è –≤–µ—Ä—Å–∏—è** ‚Äî —Å–∫–∞—á–∞–π—Ç–µ `SchoolSchedule-v${{ steps.version.outputs.VERSION }}.zip` –∏ —Ä–∞—Å–ø–∞–∫—É–π—Ç–µ
            
            ### –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ
            –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ.
          files: |
            SchoolSchedule-v${{ steps.version.outputs.VERSION }}.zip
            installer\Output\SchoolSchedule-Setup-v${{ steps.version.outputs.VERSION }}.exe
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
