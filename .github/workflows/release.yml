name: Build & Release

on:
  push:
    tags:
      - 'v*.*.*'

jobs:
  build:
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET 8
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Get version from tag
        id: version
        shell: bash
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Clean leftover build artifacts from repo
        shell: powershell
        run: |
          # Удаляем папки которые могли случайно попасть в репо
          foreach ($dir in @("release_output", "publish", "obj", "bin")) {
            if (Test-Path $dir) {
              Remove-Item $dir -Recurse -Force
              Write-Host "Removed: $dir"
            }
          }

      - name: Update AssemblyInfo.cs version
        shell: powershell
        run: |
          $ver = "${{ steps.version.outputs.VERSION }}"
          $verFull = "$ver.0"   # например 1.0.3.0
          $file = "Properties\AssemblyInfo.cs"

          if (Test-Path $file) {
            $content = Get-Content $file -Raw

            # Заменяем AssemblyVersion и AssemblyFileVersion на версию из тега
            $content = $content -replace '\[assembly:\s*AssemblyVersion\("[^"]*"\)\]',
                "[assembly: AssemblyVersion(`"$verFull`")]"
            $content = $content -replace '\[assembly:\s*AssemblyFileVersion\("[^"]*"\)\]',
                "[assembly: AssemblyFileVersion(`"$verFull`")]"

            # Если InformationalVersion уже есть — заменяем, если нет — добавляем
            if ($content -match 'AssemblyInformationalVersion') {
                $content = $content -replace '\[assembly:\s*AssemblyInformationalVersion\("[^"]*"\)\]',
                    "[assembly: AssemblyInformationalVersion(`"$ver`")]"
            } else {
                $content += "`n[assembly: AssemblyInformationalVersion(`"$ver`")]"
            }

            Set-Content $file $content -NoNewline -Encoding UTF8
            Write-Host "AssemblyInfo.cs updated to version $ver"
          } else {
            Write-Warning "Properties\AssemblyInfo.cs not found"
          }

      - name: Restore dependencies
        run: dotnet restore SchoolSchedule.sln

      - name: Publish
        shell: powershell
        run: |
          $ver = "${{ steps.version.outputs.VERSION }}"
          dotnet publish Kiosk.csproj `
            --configuration Release `
            --runtime win-x64 `
            --self-contained true `
            --output publish `
            -p:PublishSingleFile=false `
            -p:InformationalVersion="$ver"

      - name: Copy resource folders
        shell: powershell
        run: |
          foreach ($folder in @("Images", "Maps", "Pages")) {
            if (Test-Path $folder) {
              Copy-Item $folder publish -Recurse -Force
              Write-Host "Copied: $folder"
            }
          }
          if (Test-Path "settings.json") {
            Copy-Item "settings.json" publish -Force
          }
          if (Test-Path "icon.ico") {
            Copy-Item "icon.ico" publish -Force
            Write-Host "Copied: icon.ico"
          }

      - name: Create ZIP
        shell: powershell
        run: |
          $ver = "${{ steps.version.outputs.VERSION }}"
          Compress-Archive -Path "publish\*" `
            -DestinationPath "SchoolSchedule-v$ver.zip" `
            -Force
          Write-Host "Created: SchoolSchedule-v$ver.zip"

      - name: Build Installer
        shell: powershell
        run: |
          $ver = "${{ steps.version.outputs.VERSION }}"

          $iscc = "C:\Program Files (x86)\Inno Setup 6\ISCC.exe"
          if (-not (Test-Path $iscc)) {
            Write-Host "Inno Setup not found, downloading..."
            Invoke-WebRequest "https://jrsoftware.org/download.php/is.exe" -OutFile "is_setup.exe"
            Start-Process "is_setup.exe" -ArgumentList "/VERYSILENT /NORESTART" -Wait
          }

          # Подставляем версию в скрипт
          $iss = Get-Content "installer\SchoolSchedule.iss" -Raw
          $iss = $iss -replace '#define AppVersion ".*"', "#define AppVersion `"$ver`""
          New-Item -ItemType Directory -Force -Path "installer\Output" | Out-Null
          Set-Content "installer\SchoolSchedule_build.iss" $iss

          & $iscc "installer\SchoolSchedule_build.iss"

          # Находим и переименовываем exe
          $exeFile = Get-ChildItem "installer\Output" -Filter "*.exe" | Select-Object -First 1
          if ($exeFile) {
            $newName = "SchoolSchedule-Setup-v$ver.exe"
            Rename-Item $exeFile.FullName $newName -Force
            Write-Host "Installer: $newName"
          } else {
            Write-Warning "Installer exe not found, skipping"
          }

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: "SchoolSchedule ${{ github.ref_name }}"
          body: |
            SchoolSchedule ${{ github.ref_name }}

            Установка:
            - Установщик: скачайте SchoolSchedule-Setup-v${{ steps.version.outputs.VERSION }}.exe и запустите
            - Portable: скачайте ZIP, распакуйте и запустите Kiosk.exe

            Приложение проверяет обновления автоматически при каждом запуске.
          files: |
            SchoolSchedule-v${{ steps.version.outputs.VERSION }}.zip
            installer/Output/SchoolSchedule-Setup-v${{ steps.version.outputs.VERSION }}.exe
          draft: false
          prerelease: false
          fail_on_unmatched_files: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
